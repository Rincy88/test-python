name: Build SBOM and send to dt-api.
on: push
jobs:
  build:
    runs-on: ubuntu-latest  
    steps:
      - uses: actions/checkout@v3
      - name: Determine programming language
        id: determine-language 
        run: |
          language=$(echo ${GITHUB_REPOSITORY} | cut -d / -f 1 | xargs -I{} sh -c 'curl -s https://api.github.com/repos/{}/languages | jq -r 'keys_unsorted[]' | tail -1')
          echo "language=$language" >> $GITHUB_ENV
          echo "Language is $language"
      - name: Install dependencies for Node.js
        if: ${{env.language  == 'JavaScript' }}
        run: npm install
        
      - name: Install dependencies for Python
        if: ${{env.language   == 'Python' }}
        run: pip install -r requirements.txt
        
      - name: Install dependencies for Ruby
        if: ${{env.language   == 'Ruby' }}
        run: bundle install
        
      - name: Install dependencies for Java
        if: ${{ env.language   == 'Java' }}
        run: mvn install
        
      - name: Install dependencies for PHP
        if: ${{env.language  == 'PHP' }}
        run: composer install
      - name: Create SBOM with CycloneDX
        id: sbom
        uses: AppThreat/cdxgen-action@v1
        with:
          output: './reports/bom.xml' 
      - name: Save SBOM to new file 
        id: saveBom
        run: |    
         echo -n "$(cat './reports/bom.xml')"  > output.xml   
      - name: Call API
        run: | 
         REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2) 
         TAG_REF=${{ github.ref }}
           if [[ "$TAG_REF" == "refs/tags/"* ]]; then
           VERSION=$(echo "$TAG_REF" | sed 's/refs\/tags\///') 
           else
           VERSION="1.0.0" 
           fi 
         curl -k -X "POST" 'https://dt-api.staging.cryptosoft.com/api/v1/bom' \
         -H 'Content-Type: multipart/form-data' \
         -H "X-Api-Key: 1DMIXAnGtTIeTQDddlHSvpj6d3as174S " \
         -F "autoCreate=true" \
         -F "projectName=$REPO_NAME" \
         -F "projectVersion=$VERSION" \
         -F "bom=@output.xml"
